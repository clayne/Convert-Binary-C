#!perl -w
use Convert::Binary::C;
use Data::Dumper;
$Data::Dumper::Indent = 1;

%CC = (
            'Alignment' => 8,
            'Assert' => [
                          'cpu(x86_64)',
                          'machine(x86_64)',
                          'system(linux)',
                          'system(posix)',
                          'system(unix)'
                        ],
            'ByteOrder' => 'LittleEndian',
            'CharSize' => 1,
            'CompoundAlignment' => 1,
            'Define' => [
                          '_LP64=1',
                          '__ATOMIC_ACQUIRE=2',
                          '__ATOMIC_ACQ_REL=4',
                          '__ATOMIC_CONSUME=1',
                          '__ATOMIC_RELAXED=0',
                          '__ATOMIC_RELEASE=3',
                          '__ATOMIC_SEQ_CST=5',
                          '__BYTE_ORDER__=1234',
                          '__CHAR16_TYPE__=short unsigned int',
                          '__CHAR32_TYPE__=unsigned int',
                          '__CHAR_BIT__=8',
                          '__DBL_DECIMAL_DIG__=17',
                          '__DBL_DENORM_MIN__=((double)4.94065645841246544176568792868221372e-324L)',
                          '__DBL_DIG__=15',
                          '__DBL_EPSILON__=((double)2.22044604925031308084726333618164062e-16L)',
                          '__DBL_HAS_DENORM__=1',
                          '__DBL_MANT_DIG__=53',
                          '__DBL_MAX_10_EXP__=308',
                          '__DBL_MAX_EXP__=1024',
                          '__DBL_MAX__=((double)1.79769313486231570814527423731704357e+308L)',
                          '__DBL_MIN_10_EXP__=(-307)',
                          '__DBL_MIN_EXP__=(-1021)',
                          '__DBL_MIN__=((double)2.22507385850720138309023271733240406e-308L)',
                          '__DEC128_EPSILON__=1E-33DL',
                          '__DEC128_MANT_DIG__=34',
                          '__DEC128_MAX_EXP__=6145',
                          '__DEC128_MAX__=9.999999999999999999999999999999999E6144DL',
                          '__DEC128_MIN_EXP__=(-6142)',
                          '__DEC128_MIN__=1E-6143DL',
                          '__DEC128_SUBNORMAL_MIN__=0.000000000000000000000000000000001E-6143DL',
                          '__DEC32_EPSILON__=1E-6DF',
                          '__DEC32_MANT_DIG__=7',
                          '__DEC32_MAX_EXP__=97',
                          '__DEC32_MAX__=9.999999E96DF',
                          '__DEC32_MIN_EXP__=(-94)',
                          '__DEC32_MIN__=1E-95DF',
                          '__DEC32_SUBNORMAL_MIN__=0.000001E-95DF',
                          '__DEC64_EPSILON__=1E-15DD',
                          '__DEC64_MANT_DIG__=16',
                          '__DEC64_MAX_EXP__=385',
                          '__DEC64_MAX__=9.999999999999999E384DD',
                          '__DEC64_MIN_EXP__=(-382)',
                          '__DEC64_MIN__=1E-383DD',
                          '__DEC64_SUBNORMAL_MIN__=0.000000000000001E-383DD',
                          '__DECIMAL_DIG__=21',
                          '__DEC_EVAL_METHOD__=2',
                          '__ELF__=1',
                          '__FLT128_DECIMAL_DIG__=36',
                          '__FLT128_DENORM_MIN__=6.47517511943802511092443895822764655e-4966F128',
                          '__FLT128_DIG__=33',
                          '__FLT128_EPSILON__=1.92592994438723585305597794258492732e-34F128',
                          '__FLT128_MANT_DIG__=113',
                          '__FLT128_MAX_10_EXP__=4932',
                          '__FLT128_MAX_EXP__=16384',
                          '__FLT128_MAX__=1.18973149535723176508575932662800702e+4932F128',
                          '__FLT128_MIN_10_EXP__=(-4931)',
                          '__FLT128_MIN_EXP__=(-16381)',
                          '__FLT128_MIN__=3.36210314311209350626267781732175260e-4932F128',
                          '__FLT32X_DECIMAL_DIG__=17',
                          '__FLT32X_DENORM_MIN__=4.94065645841246544176568792868221372e-324F32x',
                          '__FLT32X_DIG__=15',
                          '__FLT32X_EPSILON__=2.22044604925031308084726333618164062e-16F32x',
                          '__FLT32X_MANT_DIG__=53',
                          '__FLT32X_MAX_10_EXP__=308',
                          '__FLT32X_MAX_EXP__=1024',
                          '__FLT32X_MAX__=1.79769313486231570814527423731704357e+308F32x',
                          '__FLT32X_MIN_10_EXP__=(-307)',
                          '__FLT32X_MIN_EXP__=(-1021)',
                          '__FLT32X_MIN__=2.22507385850720138309023271733240406e-308F32x',
                          '__FLT32_DECIMAL_DIG__=9',
                          '__FLT32_DENORM_MIN__=1.40129846432481707092372958328991613e-45F32',
                          '__FLT32_DIG__=6',
                          '__FLT32_EPSILON__=1.19209289550781250000000000000000000e-7F32',
                          '__FLT32_MANT_DIG__=24',
                          '__FLT32_MAX_10_EXP__=38',
                          '__FLT32_MAX_EXP__=128',
                          '__FLT32_MAX__=3.40282346638528859811704183484516925e+38F32',
                          '__FLT32_MIN_10_EXP__=(-37)',
                          '__FLT32_MIN_EXP__=(-125)',
                          '__FLT32_MIN__=1.17549435082228750796873653722224568e-38F32',
                          '__FLT64X_DECIMAL_DIG__=21',
                          '__FLT64X_DENORM_MIN__=3.64519953188247460252840593361941982e-4951F64x',
                          '__FLT64X_DIG__=18',
                          '__FLT64X_EPSILON__=1.08420217248550443400745280086994171e-19F64x',
                          '__FLT64X_MANT_DIG__=64',
                          '__FLT64X_MAX_10_EXP__=4932',
                          '__FLT64X_MAX_EXP__=16384',
                          '__FLT64X_MAX__=1.18973149535723176502126385303097021e+4932F64x',
                          '__FLT64X_MIN_10_EXP__=(-4931)',
                          '__FLT64X_MIN_EXP__=(-16381)',
                          '__FLT64X_MIN__=3.36210314311209350626267781732175260e-4932F64x',
                          '__FLT64_DECIMAL_DIG__=17',
                          '__FLT64_DENORM_MIN__=4.94065645841246544176568792868221372e-324F64',
                          '__FLT64_DIG__=15',
                          '__FLT64_EPSILON__=2.22044604925031308084726333618164062e-16F64',
                          '__FLT64_MANT_DIG__=53',
                          '__FLT64_MAX_10_EXP__=308',
                          '__FLT64_MAX_EXP__=1024',
                          '__FLT64_MAX__=1.79769313486231570814527423731704357e+308F64',
                          '__FLT64_MIN_10_EXP__=(-307)',
                          '__FLT64_MIN_EXP__=(-1021)',
                          '__FLT64_MIN__=2.22507385850720138309023271733240406e-308F64',
                          '__FLT_DECIMAL_DIG__=9',
                          '__FLT_DENORM_MIN__=1.40129846432481707092372958328991613e-45F',
                          '__FLT_DIG__=6',
                          '__FLT_EPSILON__=1.19209289550781250000000000000000000e-7F',
                          '__FLT_EVAL_METHOD_TS_18661_3__=0',
                          '__FLT_EVAL_METHOD__=0',
                          '__FLT_HAS_DENORM__=1',
                          '__FLT_MANT_DIG__=24',
                          '__FLT_MAX_10_EXP__=38',
                          '__FLT_MAX_EXP__=128',
                          '__FLT_MAX__=3.40282346638528859811704183484516925e+38F',
                          '__FLT_MIN_10_EXP__=(-37)',
                          '__FLT_MIN_EXP__=(-125)',
                          '__FLT_MIN__=1.17549435082228750796873653722224568e-38F',
                          '__FLT_RADIX__=2',
                          '__FXSR__=1',
                          '__INT16_MAX__=0x7fff',
                          '__INT16_TYPE__=short int',
                          '__INT32_MAX__=0x7fffffff',
                          '__INT32_TYPE__=int',
                          '__INT64_MAX__=0x7fffffffffffffffL',
                          '__INT64_TYPE__=long int',
                          '__INT8_MAX__=0x7f',
                          '__INT8_TYPE__=signed char',
                          '__INTMAX_MAX__=0x7fffffffffffffffL',
                          '__INTMAX_TYPE__=long int',
                          '__INTMAX_WIDTH__=64',
                          '__INTPTR_MAX__=0x7fffffffffffffffL',
                          '__INTPTR_TYPE__=long int',
                          '__INTPTR_WIDTH__=64',
                          '__INT_FAST16_MAX__=0x7fffffffffffffffL',
                          '__INT_FAST16_TYPE__=long int',
                          '__INT_FAST16_WIDTH__=64',
                          '__INT_FAST32_MAX__=0x7fffffffffffffffL',
                          '__INT_FAST32_TYPE__=long int',
                          '__INT_FAST32_WIDTH__=64',
                          '__INT_FAST64_MAX__=0x7fffffffffffffffL',
                          '__INT_FAST64_TYPE__=long int',
                          '__INT_FAST64_WIDTH__=64',
                          '__INT_FAST8_MAX__=0x7f',
                          '__INT_FAST8_TYPE__=signed char',
                          '__INT_FAST8_WIDTH__=8',
                          '__INT_LEAST16_MAX__=0x7fff',
                          '__INT_LEAST16_TYPE__=short int',
                          '__INT_LEAST16_WIDTH__=16',
                          '__INT_LEAST32_MAX__=0x7fffffff',
                          '__INT_LEAST32_TYPE__=int',
                          '__INT_LEAST32_WIDTH__=32',
                          '__INT_LEAST64_MAX__=0x7fffffffffffffffL',
                          '__INT_LEAST64_TYPE__=long int',
                          '__INT_LEAST64_WIDTH__=64',
                          '__INT_LEAST8_MAX__=0x7f',
                          '__INT_LEAST8_TYPE__=signed char',
                          '__INT_LEAST8_WIDTH__=8',
                          '__INT_MAX__=0x7fffffff',
                          '__INT_WIDTH__=32',
                          '__LDBL_DECIMAL_DIG__=21',
                          '__LDBL_DENORM_MIN__=3.64519953188247460252840593361941982e-4951L',
                          '__LDBL_DIG__=18',
                          '__LDBL_EPSILON__=1.08420217248550443400745280086994171e-19L',
                          '__LDBL_HAS_DENORM__=1',
                          '__LDBL_MANT_DIG__=64',
                          '__LDBL_MAX_10_EXP__=4932',
                          '__LDBL_MAX_EXP__=16384',
                          '__LDBL_MAX__=1.18973149535723176502126385303097021e+4932L',
                          '__LDBL_MIN_10_EXP__=(-4931)',
                          '__LDBL_MIN_EXP__=(-16381)',
                          '__LDBL_MIN__=3.36210314311209350626267781732175260e-4932L',
                          '__LONG_LONG_MAX__=0x7fffffffffffffffLL',
                          '__LONG_LONG_WIDTH__=64',
                          '__LONG_MAX__=0x7fffffffffffffffL',
                          '__LONG_WIDTH__=64',
                          '__LP64__=1',
                          '__MMX__=1',
                          '__NO_INLINE__=1',
                          '__ORDER_BIG_ENDIAN__=4321',
                          '__ORDER_LITTLE_ENDIAN__=1234',
                          '__ORDER_PDP_ENDIAN__=3412',
                          '__PIC__=2',
                          '__PRAGMA_REDEFINE_EXTNAME=1',
                          '__PTRDIFF_MAX__=0x7fffffffffffffffL',
                          '__PTRDIFF_TYPE__=long int',
                          '__PTRDIFF_WIDTH__=64',
                          '__SCHAR_MAX__=0x7f',
                          '__SCHAR_WIDTH__=8',
                          '__SHRT_MAX__=0x7fff',
                          '__SHRT_WIDTH__=16',
                          '__SIG_ATOMIC_MAX__=0x7fffffff',
                          '__SIG_ATOMIC_MIN__=(-0x7fffffff - 1)',
                          '__SIG_ATOMIC_WIDTH__=32',
                          '__SIZEOF_INT__=4',
                          '__SIZEOF_LONG_LONG__=8',
                          '__SIZEOF_LONG__=8',
                          '__SIZEOF_POINTER__=8',
                          '__SIZEOF_SHORT__=2',
                          '__SIZEOF_SIZE_T__=8',
                          '__SIZEOF_WCHAR_T__=4',
                          '__SIZE_MAX__=0xffffffffffffffffUL',
                          '__SIZE_TYPE__=long unsigned int',
                          '__SIZE_WIDTH__=64',
                          '__SSE2__=1',
                          '__SSE__=1',
                          '__UINT16_MAX__=0xffff',
                          '__UINT16_TYPE__=short unsigned int',
                          '__UINT32_MAX__=0xffffffffU',
                          '__UINT32_TYPE__=unsigned int',
                          '__UINT64_MAX__=0xffffffffffffffffUL',
                          '__UINT64_TYPE__=long unsigned int',
                          '__UINT8_MAX__=0xff',
                          '__UINT8_TYPE__=unsigned char',
                          '__UINTMAX_MAX__=0xffffffffffffffffUL',
                          '__UINTMAX_TYPE__=long unsigned int',
                          '__UINTPTR_MAX__=0xffffffffffffffffUL',
                          '__UINTPTR_TYPE__=long unsigned int',
                          '__UINT_FAST16_MAX__=0xffffffffffffffffUL',
                          '__UINT_FAST16_TYPE__=long unsigned int',
                          '__UINT_FAST32_MAX__=0xffffffffffffffffUL',
                          '__UINT_FAST32_TYPE__=long unsigned int',
                          '__UINT_FAST64_MAX__=0xffffffffffffffffUL',
                          '__UINT_FAST64_TYPE__=long unsigned int',
                          '__UINT_FAST8_MAX__=0xff',
                          '__UINT_FAST8_TYPE__=unsigned char',
                          '__UINT_LEAST16_MAX__=0xffff',
                          '__UINT_LEAST16_TYPE__=short unsigned int',
                          '__UINT_LEAST32_MAX__=0xffffffffU',
                          '__UINT_LEAST32_TYPE__=unsigned int',
                          '__UINT_LEAST64_MAX__=0xffffffffffffffffUL',
                          '__UINT_LEAST64_TYPE__=long unsigned int',
                          '__UINT_LEAST8_MAX__=0xff',
                          '__UINT_LEAST8_TYPE__=unsigned char',
                          '__USER_LABEL_PREFIX__=',
                          '__WCHAR_MAX__=0x7fffffff',
                          '__WCHAR_MIN__=(-0x7fffffff - 1)',
                          '__WCHAR_TYPE__=int',
                          '__WCHAR_WIDTH__=32',
                          '__WINT_MAX__=0xffffffffU',
                          '__WINT_MIN__=0U',
                          '__WINT_TYPE__=unsigned int',
                          '__WINT_WIDTH__=32',
                          '__amd64=1',
                          '__amd64__=1',
                          '__builtin_va_list=int',
                          '__gnu_linux__=1',
                          '__linux=1',
                          '__linux__=1',
                          '__pic__=2',
                          '__unix=1',
                          '__unix__=1',
                          '__x86_64=1',
                          '__x86_64__=1',
                          'linux=1',
                          'unix=1',
                          '_Bool=char',
                        ],
            'DoubleSize' => 8,
            'EnumSize' => 4,
            'FloatSize' => 4,
            'HasCPPComments' => 1,
            'HostedC' => 1,
            'Include' => [
                           '/usr/lib/gcc/x86_64-pc-linux-gnu/9.3.0/include-fixed',
                           '/usr/lib/gcc/x86_64-pc-linux-gnu/9.3.0/include',
                           '/usr/include'
                         ],
            'IntSize' => 4,
            'KeywordMap' => {
                              '__asm' => 'asm',
                              '__asm__' => 'asm',
                              '__complex' => undef,
                              '__complex__' => undef,
                              '__const' => 'const',
                              '__const__' => 'const',
                              '__extension__' => undef,
                              '__imag' => undef,
                              '__imag__' => undef,
                              '__inline' => 'inline',
                              '__inline__' => 'inline',
                              '__real' => undef,
                              '__real__' => undef,
                              '__restrict' => 'restrict',
                              '__restrict__' => 'restrict',
                              '__signed' => 'signed',
                              '__signed__' => 'signed',
                              '__volatile' => 'volatile',
                              '__volatile__' => 'volatile',
                            },
            'LongDoubleSize' => 16,
            'LongLongSize' => 8,
            'LongSize' => 8,
            'PointerSize' => 8,
            'ShortSize' => 2,
            'UnsignedChars' => 0
      );

#-8<-

use Config;

$c = Convert::Binary::C->new(%CC, OrderMembers => 1);
$c->Include(["$Config{archlib}/CORE", @{$c->Include}]);
$c->parse(<<ENDC);
#include "EXTERN.h"
#include "perl.h"
ENDC

$c->tag($_, Hooks => { unpack_ptr => [\&unpack_ptr,
                                      $c->arg(qw(SELF TYPE DATA))] })
    for qw( XPVAV XPVHV );

#-8<-

sub unpack_ptr {
  my($self, $type, $ptr) = @_;
  $ptr or return '<NULL>';
  my $size = $self->sizeof($type);
  $self->unpack($type, unpack("P$size", pack('Q', $ptr)));
}

#-8<-

my $ref = { foo => 42, bar => 4711 };
my $ptr = hex(("$ref" =~ /\(0x([[:xdigit:]]+)\)$/)[0]);

print Dumper(unpack_ptr($c, 'AV', $ptr));
